<div class="incident-container">
  
  <div class="list-panel">
    <div class="panel-header">
      <h3><i class="fas fa-exclamation-triangle"></i> Danh s√°ch s·ª± c·ªë</h3>
    </div>
    
    <div class="incident-list">
      <div 
        class="incident-card" 
        *ngFor="let item of incidents" 
        [class.active]="selectedIncident?.incidentId === item.incidentId"
        (click)="selectIncident(item)">
        
        <div class="card-thumb">
          <img 
            [src]="item.images && item.images.length > 0 ? getImageUrl(item.images[0].filePath) : 'assets/images/no-image.png'" 
            alt="thumb">
        </div>
        
        <div class="card-info">
          <h4 class="card-title" title="{{ item.title }}">{{ item.title }}</h4>
          <div class="card-addr">{{ item.ward }}</div>
          
          <span class="status-badge" [ngClass]="getStatusClass(item.status)">
            {{ item.status }}
          </span>
        </div>
      </div>
    </div>
  </div>

  <div class="detail-panel">
    
    <div class="empty-state" *ngIf="!selectedIncident">
      <img src="assets/images/select-incident.png" onerror="this.style.display='none'" width="150">
      <p>Ch·ªçn m·ªôt s·ª± c·ªë ƒë·ªÉ xem chi ti·∫øt v√† x·ª≠ l√Ω</p>
    </div>

    <div class="detail-content" *ngIf="selectedIncident">
      
      <div class="detail-top">
        
        <div class="image-gallery">
          
          <div class="main-img-box">
            <img 
              [src]="activeImage ? getImageUrl(activeImage.filePath) : 'assets/images/no-image.png'" 
              alt="Main">
          </div>
          
          <div class="sub-images" *ngIf="selectedIncident.images && selectedIncident.images.length > 1">
            <img 
              *ngFor="let img of selectedIncident.images" 
              [src]="getImageUrl(img.filePath)"
              [class.active-thumb]="activeImage === img"
              (click)="activeImage = img"
              title="Xem ·∫£nh n√†y">
          </div>
        </div>

        <div class="info-box">
          <h2>{{ selectedIncident.title }}</h2>
          <div class="meta-row">
            <span><i class="fas fa-clock"></i> {{ selectedIncident.createdAt | date:'dd/MM/yyyy HH:mm' }}</span>
            <span><i class="fas fa-tag"></i> {{ selectedIncident.categoryName }}</span>
          </div>
          
          <div class="desc-box">
            <strong>M√¥ t·∫£ chi ti·∫øt:</strong>
            <p>{{ selectedIncident.description }}</p>
          </div>

          <div class="addr-box">
            <i class="fas fa-map-marker-alt text-red"></i> 
            {{ selectedIncident.address }}, {{ selectedIncident.streetName }}, {{ selectedIncident.ward }}
          </div>
        </div>
      </div>

      <hr>

      <div class="action-zone">
        
        <div class="admin-actions" *ngIf="isAdmin">
          <h3><i class="fas fa-user-shield"></i> Duy·ªát & ƒêi·ªÅu ph·ªëi</h3>
          
          <div class="control-row">
            <div class="control-group">
              <label>M·ª©c ƒë·ªô c·∫£nh b√°o:</label>
              <select [(ngModel)]="updateData.alertLevel">
                <option [value]="1">üü¢ B√¨nh th∆∞·ªùng (Xanh)</option>
                <option [value]="2">üü† C·∫£nh b√°o (Cam)</option>
                <option [value]="3">üî¥ Nguy hi·ªÉm (ƒê·ªè)</option>
              </select>
            </div>

            <div class="control-group">
              <label>ƒê∆°n v·ªã x·ª≠ l√Ω:</label>
              <select [(ngModel)]="updateData.assignedDepartmentId">
                <option [ngValue]="undefined">-- Ch·ªçn ph√≤ng ban --</option>
                <option *ngFor="let d of departments" [value]="d.departmentId">{{ d.name }}</option>
              </select>
            </div>
          </div>

          <div class="duplicate-check" *ngIf="suggestedDuplicates.length > 0">
            <div class="dup-title">‚ö†Ô∏è Ph√°t hi·ªán s·ª± c·ªë tr√πng l·∫∑p v·ªã tr√≠:</div>
            <div class="dup-list">
              <div class="dup-item" *ngFor="let dup of suggestedDuplicates">
                <input type="checkbox" (change)="toggleDuplicate(dup.incidentId)">
                <div style="flex: 1">
                    <strong>{{ dup.title }}</strong> 
                    <span style="font-size: 11px; color: #666"> ({{ dup.createdAt | date:'dd/MM' }})</span>
                </div>
                <span class="badge-dup">Ch·ªù x·ª≠ l√Ω</span>
              </div>
            </div>
            <small class="hint-text">* Ch·ªçn ƒë·ªÉ g·ªôp v√†o s·ª± c·ªë n√†y (S·ª± c·ªë ƒë∆∞·ª£c ch·ªçn s·∫Ω ƒë√≥ng)</small>
          </div>

          <div class="btn-row">
            <button class="btn-reject" (click)="reject()">üö´ T·ª´ ch·ªëi</button>
            <button class="btn-approve" (click)="approveAndAssign()">‚úÖ Duy·ªát & Chuy·ªÉn x·ª≠ l√Ω</button>
          </div>
        </div>

        <div class="staff-actions" *ngIf="!isAdmin">
          <h3><i class="fas fa-tools"></i> C·∫≠p nh·∫≠t ti·∫øn ƒë·ªô</h3>
          
          <div class="current-status">
            Tr·∫°ng th√°i hi·ªán t·∫°i: <span class="status-text-bold">{{ selectedIncident.status }}</span>
          </div>

          <div class="control-group" style="margin-top: 15px;">
            <label>Ghi ch√∫ ti·∫øn ƒë·ªô / K·∫øt qu·∫£:</label>
            <textarea [(ngModel)]="updateData.note" rows="3" placeholder="Nh·∫≠p n·ªôi dung c·∫≠p nh·∫≠t..."></textarea>
          </div>

          <div class="btn-row">
            <button class="btn-process" (click)="updateProgress('ƒêang x·ª≠ l√Ω')">üõ† ƒêang x·ª≠ l√Ω</button>
            <button class="btn-complete" (click)="updateProgress('ƒê√£ ho√†n th√†nh')">üéâ Ho√†n th√†nh</button>
          </div>
        </div>

      </div>

    </div>
  </div>
</div>