<div class="incident-container">
  
  <div class="list-panel">
    <div class="panel-header">
      <h3><i class="fas fa-exclamation-triangle"></i> Danh s√°ch s·ª± c·ªë</h3>
    </div>
    <div class="incident-list">
      <div class="incident-card" *ngFor="let item of incidents" 
        [class.active]="selectedIncident?.incidentId === item.incidentId" (click)="selectIncident(item)">
        <div class="card-thumb">
          <img [src]="item.images && item.images.length > 0 ? getImageUrl(item.images[0].filePath) : 'assets/images/no-image.png'">
        </div>
        <div class="card-info">
          <div class="title-row">
             <h4 class="card-title" title="{{ item.title }}">{{ item.title }}</h4>
             <span class="vote-badge" *ngIf="item.voteCount > 1">üî• {{ item.voteCount }}</span>
          </div>
          <div class="card-addr"><i class="fas fa-map-marker-alt"></i> {{ item.ward }}</div>
          <span class="status-badge" [ngClass]="getStatusClass(item.status)">{{ item.status }}</span>
        </div>
      </div>
    </div>
  </div>

  <div class="detail-panel">
    <div class="empty-state" *ngIf="!selectedIncident">
      <img src="assets/images/select-incident.png" onerror="this.style.display='none'" width="150">
      <p>Ch·ªçn m·ªôt s·ª± c·ªë ƒë·ªÉ xem chi ti·∫øt v√† x·ª≠ l√Ω</p>
    </div>

    <div class="detail-content" *ngIf="selectedIncident">
      
      <div class="detail-top">
        <div class="image-gallery">
          <div class="main-img-box">
            <img [src]="activeImage ? getImageUrl(activeImage.filePath) : 'assets/images/no-image.png'">
          </div>
          <div class="sub-images" *ngIf="selectedIncident.images && selectedIncident.images.length > 1">
            <img *ngFor="let img of selectedIncident.images" [src]="getImageUrl(img.filePath)"
              [class.active-thumb]="activeImage === img" (click)="activeImage = img">
          </div>
        </div>

        <div class="info-box">
          <h2>{{ selectedIncident.title }}</h2>
          <div class="meta-row">
            <span><i class="far fa-clock"></i> {{ selectedIncident.createdAt | date:'dd/MM/yyyy HH:mm' }}</span>
            <span><i class="fas fa-tag"></i> {{ selectedIncident.categoryName }}</span>
          </div>
          <div class="desc-box">
            <strong><i class="fas fa-align-left"></i> M√¥ t·∫£ chi ti·∫øt:</strong>
            <p>{{ selectedIncident.description }}</p>
          </div>
          <div class="addr-box">
            <i class="fas fa-map-marker-alt text-red"></i> 
            {{ selectedIncident.address }}, {{ selectedIncident.streetName }}, {{ selectedIncident.ward }}
          </div>
        </div>
      </div>

      <hr>

      <div class="action-zone">
        
        <div class="alert-processed" 
             [class.alert-rejected]="selectedIncident.status === 'T·ª´ ch·ªëi'"
             *ngIf="selectedIncident.status !== 'Ch·ªù x·ª≠ l√Ω' && !isStaff && !isAdmin">
             <div>
                <i class="fas" [ngClass]="selectedIncident.status === 'T·ª´ ch·ªëi' ? 'fa-times-circle' : 'fa-check-circle'"></i> 
                S·ª± c·ªë n√†y ƒëang ·ªü tr·∫°ng th√°i: <b>{{ selectedIncident.status }}</b>
             </div>
             <div *ngIf="selectedIncident.assignedDepartmentName">
                <small>ƒê∆°n v·ªã ph·ª• tr√°ch: {{ selectedIncident.assignedDepartmentName }}</small>
             </div>
        </div>

        <div class="admin-actions" *ngIf="isAdmin && selectedIncident.status === 'Ch·ªù x·ª≠ l√Ω'">
          <h3><i class="fas fa-user-shield"></i> Duy·ªát & ƒêi·ªÅu ph·ªëi (Admin)</h3>
          <div class="control-row">
            <div class="control-group">
              <label>M·ª©c ƒë·ªô c·∫£nh b√°o:</label>
              <select [(ngModel)]="updateData.alertLevel">
                <option [ngValue]="1">üü¢ B√¨nh th∆∞·ªùng</option>
                <option [ngValue]="2">üü† C·∫£nh b√°o</option>
                <option [ngValue]="3">üî¥ Nguy hi·ªÉm</option>
              </select>
            </div>
            <div class="control-group">
              <label>ƒê∆°n v·ªã x·ª≠ l√Ω:</label>
              <select [(ngModel)]="updateData.assignedDepartmentId">
                <option [ngValue]="undefined">-- Ch·ªçn ph√≤ng ban --</option>
                <option *ngFor="let d of departments" [ngValue]="d.departmentId">{{ d.name }}</option>
              </select>
            </div>
          </div>
          <ng-container *ngTemplateOutlet="duplicateTemplate"></ng-container>
          <div class="btn-row">
            <button class="btn btn-reject" (click)="reject()"><i class="fas fa-times-circle"></i> T·ª´ ch·ªëi</button>
            <button class="btn btn-approve" (click)="approveAndAssign()">
              <i class="fas fa-check-circle"></i> 
              {{ selectedDuplicateIds.length > 0 ? 'G·ªôp & Duy·ªát' : 'Duy·ªát & Chuy·ªÉn' }}
            </button>
          </div>
        </div>

        <div class="staff-actions" *ngIf="isStaff || (isAdmin && selectedIncident.status !== 'Ch·ªù x·ª≠ l√Ω')">
          
          <h3><i class="fas fa-tools"></i> X·ª≠ l√Ω s·ª± c·ªë</h3>
          
          <div class="transfer-section" *ngIf="selectedIncident.status !== 'ƒê√£ ho√†n th√†nh' && selectedIncident.status !== 'T·ª´ ch·ªëi'">
             <div class="control-row">
                
                <div class="control-group">
                   <label>M·ª©c ƒë·ªô c·∫£nh b√°o:</label>
                   <select [(ngModel)]="updateData.alertLevel">
                      <option [ngValue]="1">üü¢ B√¨nh th∆∞·ªùng</option>
                      <option [ngValue]="2">üü† C·∫£nh b√°o</option>
                      <option [ngValue]="3">üî¥ Nguy hi·ªÉm</option>
                   </select>
                </div>

                <div class="control-group">
                   <label>Chuy·ªÉn ƒë∆°n v·ªã (N·∫øu sai):</label>
                   <div style="display: flex; gap: 5px;">
                      <select [(ngModel)]="updateData.assignedDepartmentId" style="flex: 1;">
                         <option *ngFor="let d of departments" [ngValue]="d.departmentId">{{ d.name }}</option>
                      </select>
                      <button class="btn-icon-only" title="Chuy·ªÉn ngay" (click)="transferDepartment()">
                         <i class="fas fa-share-square"></i>
                      </button>
                   </div>
                </div>
             </div>
          </div>

          <ng-container *ngTemplateOutlet="duplicateTemplate"></ng-container>

          <div class="control-group" style="margin-top: 15px;">
            <label>Ghi ch√∫ / K·∫øt qu·∫£ x·ª≠ l√Ω:</label>
            <textarea [(ngModel)]="updateData.note" rows="3" placeholder="Nh·∫≠p n·ªôi dung..."></textarea>
          </div>

          <div class="btn-row" *ngIf="selectedIncident.status !== 'ƒê√£ ho√†n th√†nh' && selectedIncident.status !== 'T·ª´ ch·ªëi'">
            
            <button class="btn btn-reject" (click)="reject()">
              <i class="fas fa-times-circle"></i> T·ª´ ch·ªëi
            </button>

            <button class="btn btn-approve" *ngIf="selectedDuplicateIds.length > 0" (click)="updateProgress('ƒêang x·ª≠ l√Ω')">
               <i class="fas fa-object-group"></i> G·ªôp {{ selectedDuplicateIds.length }} phi·∫øu
            </button>

            <button class="btn btn-process" *ngIf="selectedIncident.status === 'Ch·ªù x·ª≠ l√Ω'" (click)="updateProgress('ƒêang x·ª≠ l√Ω')">
              <i class="fas fa-play"></i> Ti·∫øp nh·∫≠n
            </button>
            
            <button class="btn btn-complete" (click)="updateProgress('ƒê√£ ho√†n th√†nh')">
              <i class="fas fa-check-double"></i> Ho√†n th√†nh
            </button>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<ng-template #duplicateTemplate>
  <div class="duplicate-section" *ngIf="suggestedDuplicates.length > 0 && selectedIncident?.status !== 'ƒê√£ ho√†n th√†nh' && selectedIncident?.status !== 'T·ª´ ch·ªëi'">
    <div class="dup-header"><i class="fas fa-clone"></i> Ph√°t hi·ªán {{ suggestedDuplicates.length }} s·ª± c·ªë t∆∞∆°ng t·ª±</div>
    <div class="dup-list">
      <div class="dup-item" *ngFor="let dup of suggestedDuplicates">
        <label class="checkbox-container">
          <input type="checkbox" (change)="toggleDuplicate(dup.incidentId)">
          <span class="checkmark"></span>
        </label>
        <div class="dup-info">
          <div class="dup-title">{{ dup.title }}</div>
          <div class="dup-meta"><i class="far fa-clock"></i> {{ dup.createdAt | date:'dd/MM' }} - {{ dup.status }}</div>
        </div>
        <span class="badge-dup">Tr√πng l·∫∑p</span>
      </div>
    </div>
    <div class="merge-hint"><i class="fas fa-info-circle"></i> T√≠ch ch·ªçn ƒë·ªÉ g·ªôp ·∫£nh v√† c·ªông ƒëi·ªÉm cho ng∆∞·ªùi b√°o c√°o.</div>
  </div>
</ng-template>

<div class="modal-backdrop" *ngIf="confirmModal.show" style="z-index: 3000;">
  <div class="modal-content-small">
    <div class="modal-icon" [ngClass]="confirmModal.type === 'reject' ? 'icon-warning' : 'icon-info'">
      <i class="fas" [ngClass]="confirmModal.type === 'reject' ? 'fa-exclamation-triangle' : 'fa-question'"></i>
    </div>
    <h3 class="modal-title">{{ confirmModal.title }}</h3>
    <p class="modal-desc">{{ confirmModal.message }}</p>
    <div class="modal-actions">
      <button class="btn-modal btn-cancel" (click)="confirmModal.show = false">H·ªßy b·ªè</button>
      <button class="btn-modal" [ngClass]="confirmModal.type === 'reject' ? 'btn-danger' : 'btn-primary'" (click)="onConfirm()">ƒê·ªìng √Ω</button>
    </div>
  </div>
</div>

<div class="modal-backdrop" *ngIf="resultModal.show" style="z-index: 3001;">
  <div class="modal-content-small">
    <div class="modal-icon" [ngClass]="resultModal.isSuccess ? 'icon-success' : 'icon-error'">
      <i class="fas" [ngClass]="resultModal.isSuccess ? 'fa-check' : 'fa-times'"></i>
    </div>
    <h3 class="modal-title">{{ resultModal.isSuccess ? 'Th√†nh c√¥ng!' : 'Th·∫•t b·∫°i' }}</h3>
    <p class="modal-desc">{{ resultModal.message }}</p>
    <div class="modal-actions">
      <button class="btn-modal btn-primary" style="width: 100%;" (click)="closeResultModal()">ƒê√≥ng</button>
    </div>
  </div>
</div>